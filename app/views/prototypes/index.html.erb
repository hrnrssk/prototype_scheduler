<% require "date" %>
<h1>試作品一覧</h1>
<%= search_form_for @q do |f| %>
  <%= f.label :order_number_or_name, "注文番号/品名検索：" %>
  <%= f.search_field :order_number_or_name_cont %>

  <%= f.submit "検索" %>
<% end %>

<table>
  <tr>
    <th><%= sort_link(@q, :order_number, "注文番号") %></th>
    <th><%= sort_link(@q, :customer, "得意先") %></th>
    <th><%= sort_link(@q, :name, "品名") %></th>
    <th><%= sort_link(@q, :delivery_date, "納期") %></th>
    <th><%= sort_link(@q, :scheduled_to_end, "完了予定") %></th>
    <th><%= sort_link(@q, :days_of_grace, "猶予日数") %></th>
  </tr>
<% @prototypes.each do |prototype| %>
  <tr>
    <td><%= prototype.order_number %></td>
    <td><%= prototype.customer %></td>
    <td><%= prototype.name %></td>
    <td><%= prototype.delivery_date %></td>
    <% if @flows.where(prototype_id: prototype.id).maximum(:scheduled_ending_time) == nil then %>
      <td><%= "" %></td>
    <% else %>
      <td><%= @flows.where(prototype_id: prototype.id).maximum(:scheduled_ending_time).strftime("%Y-%m-%d") %></td>
    <% end %>
    <td><%= (prototype.delivery_date - Date.today).to_i %></td>
    <td><%= link_to '工程フロー', prototype_flow_path(prototype.id, prototype.id) %></td>
    <td><%= link_to "情報編集", edit_prototype_path(prototype.id) %></td>
    <td><%= link_to '削除', prototype_path(prototype.id), method: :delete, data: { confirm: '本当に削除していいですか？' } %></td>
  </tr>
<% end %>
</table>
<%= link_to '試作品登録へ', new_prototype_path %>


<h1>工程フロー詳細</h1>
<table>
  <tr>
    <th>試作品No.</th>
    <th>工程No.</th>
    <th>工程名</th>
    <th>所要時間</th>
    <th>作業者</th>
    <th>開始予定</th>
    <th>終了予定</th>
    <th>終了実績</th> 
  </tr>
<% @flows.each do |flow| %>
  <tr>
    <td><%= flow.prototype_id %></td>
    <td><%= flow.number %></td>
    <td><%= flow.processing.name %></td>
    <td><%= flow.processing.time_required.strftime('%H:%M') %></td>
    <td><%= flow.processing.working_users.find(flow.user_id).name %></td>
    <% if flow.scheduled_starting_time == nil then %>
      <td><%= "" %></td>
    <% else %>
      <td><%= flow.scheduled_starting_time.strftime("%Y-%m-%d %H:%M") %></td>
    <% end %>
    <% if flow.scheduled_ending_time == nil then %>
      <td><%= "" %></td>
    <% else %>
      <td><%= flow.scheduled_ending_time.strftime("%Y-%m-%d %H:%M") %></td>
    <% end %>
    <% if flow.ending_time == nil then %>
      <td><%= "" %></td>
    <% else %>
      <td><%= flow.ending_time.strftime("%Y-%m-%d %H:%M") %></td>
    <% end %>
  </tr>
<% end %>